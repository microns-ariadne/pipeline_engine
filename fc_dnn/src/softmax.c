/////////////////////////////////////////////////////////////////////////////////////////
//
//
//
/////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////
// INCLUDES
/////////////////////////////////////////////////////////////////////////////////////////
#include "common.h"
#include <math.h>
#include "softmax.h"

/////////////////////////////////////////////////////////////////////////////////////////
// DEFINES
/////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////
// TYPES
/////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////
// GLOBALS
/////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////
// INTERNAL FUNCTIONS
/////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////
// EXTERNAL FUNCTIONS
/////////////////////////////////////////////////////////////////////////////////////////
void softmax(float * __restrict__ p_in_matrix,
             int m_d1,
             int m_d2,
             int n_channels, 
             float * __restrict__ p_out_matrix) {
    
    float output_channels[MAX_OUTPUT_CHANNELS];
                 
    DNN_TRACE_4("start %s\n","");
    DNN_TRACE_4(" p_in_matrix: %p [%d,%d,%d]\n", p_in_matrix, m_d1, m_d2, n_channels);
    DNN_TRACE_4(" p_out_matrix: %p\n", p_out_matrix);
    
    for (int cur_m_d1 = 0; cur_m_d1 < m_d1; cur_m_d1++) {
        
        int offset_d1 = D1_TO_OFFSET(cur_m_d1, m_d2, n_channels);
        
        for (int cur_m_d2 = 0; cur_m_d2 < m_d2; cur_m_d2++) {
            
            int offset_d2 = D2_TO_OFFSET(cur_m_d2, n_channels);
            
            float sum_exps = 0;
            for (int k = 0; k < n_channels; k++) {
                output_channels[k] = expf(p_in_matrix[offset_d1 + offset_d2 + k]);
                sum_exps += output_channels[k];
            }
            
            for (int k = 0; k < n_channels; k++) {
                output_channels[k] /= sum_exps;
                p_out_matrix[offset_d1 + offset_d2 + k] = output_channels[k];
            }
        }
    }
    
    DNN_TRACE_4("finish %s\n","");
}
